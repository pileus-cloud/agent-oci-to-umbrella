version: '3.8'

# Docker Compose with Docker Secrets Support
# For production deployments using Docker Swarm
#
# Setup:
#   1. Create secrets:
#      echo "AKIA..." | docker secret create aws_access_key_id -
#      echo "secret..." | docker secret create aws_secret_access_key -
#      echo "ocid1.user..." | docker secret create oci_user_ocid -
#      echo "aa:bb:cc..." | docker secret create oci_fingerprint -
#      echo "ocid1.tenancy..." | docker secret create oci_tenancy_ocid -
#      cat oci_private_key.pem | docker secret create oci_private_key -
#
#   2. Deploy:
#      docker stack deploy -c docker-compose.secrets.yml agent-oci-to-umbrella
#
# Note: Requires Docker Swarm mode (docker swarm init)

services:
  agent-oci-to-umbrella:
    build:
      context: .
      dockerfile: Dockerfile
    image: agent-oci-to-umbrella:latest
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Volume mounts for persistent data
    volumes:
      # Configuration
      - ./config:/config:ro

      # Logs and state (persistent)
      - ./logs:/logs
      - ./state:/state

    # Docker Secrets (mounted at /run/secrets/<secret_name>)
    secrets:
      - aws_access_key_id
      - aws_secret_access_key
      - oci_user_ocid
      - oci_fingerprint
      - oci_tenancy_ocid
      - oci_private_key

    # Environment variables (non-secret)
    environment:
      - AGENT_CONFIG=/config/config.yaml
      - AWS_DEFAULT_REGION=us-east-1
      - OCI_REGION=us-ashburn-1
      # Tell agent to read secrets from /run/secrets/
      - USE_DOCKER_SECRETS=true
      # Path to OCI private key secret
      - OCI_KEY_FILE=/run/secrets/oci_private_key

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "agent-oci-to-umbrella", "status"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

# Docker Secrets definitions
secrets:
  aws_access_key_id:
    external: true
  aws_secret_access_key:
    external: true
  oci_user_ocid:
    external: true
  oci_fingerprint:
    external: true
  oci_tenancy_ocid:
    external: true
  oci_private_key:
    external: true
